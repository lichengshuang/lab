#!/bin/bash
# *****************************************************************************
# ブータブルCDの作成手順 [amd64/i386 netinstall]
# *****************************************************************************
  apt-get install -y genisoimage jigdo-file
# = stable [8.2.0] ============================================================
  cd ~
  rm -rf ~/stable
  mkdir -p ~/stable/image
  mkdir -p ~/stable/install.386
  mkdir -p ~/stable/install.amd
# - start ---------------------------------------------------------------------
  pushd ~/stable
    wget "https://raw.githubusercontent.com/office-itou/lab/master/Linux/installer/preseed.cfg"
    jigdo-lite --noask "http://cdimage.debian.org/debian-cd/current/multi-arch/jigdo-cd/debian-8.2.0-amd64-i386-netinst.jigdo"
# - mount ---------------------------------------------------------------------
    mount -o loop debian-8.2.0-amd64-i386-netinst.iso /mnt
    pushd /mnt
    find . -depth -print | cpio -pdm ~/stable/image/
    popd
    umount -f /mnt
# - i386 ----------------------------------------------------------------------
    cd ~/stable/install.386
    gunzip < ~/stable/image/install.386/initrd.gz | cpio -i
    cp -p ~/stable/preseed.cfg .
    mv ~/stable/image/install.386/initrd.gz ~/stable/image/install.386/initrd.gz.orig
    find . | cpio -H newc --create | gzip -9 > ~/stable/image/install.386/initrd.gz
    cat <<- _EOT_ > ~/stable/image/install.386/syslinux.cfg
		default vmlinuz
		append auto=true vga=normal file=/preseed.cfg initrd=initrd.gz priority=critical console-setup/ask_detect=false pkgsel/language-pack-patterns= pkgsel/install-language-support=false quiet --
_EOT_
# - amd -----------------------------------------------------------------------
    cd ~/stable/install.amd
    gunzip < ~/stable/image/install.amd/initrd.gz | cpio -i
    cp -p ~/stable/preseed.cfg .
    mv ~/stable/image/install.amd/initrd.gz ~/stable/image/install.amd/initrd.gz.orig
    find . | cpio -H newc --create | gzip -9 > ~/stable/image/install.amd/initrd.gz
    cat <<- _EOT_ > ~/stable/image/install.amd/syslinux.cfg
		default vmlinuz
		append auto=true vga=normal file=/preseed.cfg initrd=initrd.gz priority=critical console-setup/ask_detect=false pkgsel/language-pack-patterns= pkgsel/install-language-support=false quiet --
_EOT_
# - imaging -------------------------------------------------------------------
    cd ~/stable/image
    genisoimage -J -r -R -o ~/stable/debian-8.2.0-amd64-i386-netinst-preseed.iso -b isolinux/isolinux.bin -c isolinux/boot.cat -no-emul-boot -boot-load-size 4 -boot-info-table .
  popd
# = testing ===================================================================
  cd ~
  rm -rf ~/testing
  mkdir -p ~/testing/image
  mkdir -p ~/testing/install.386
  mkdir -p ~/testing/install.amd
# - start ---------------------------------------------------------------------
  pushd ~/testing
    wget "https://raw.githubusercontent.com/office-itou/lab/master/Linux/installer/preseed.cfg"
    jigdo-lite --noask "http://cdimage.debian.org/cdimage/weekly-builds/multi-arch/jigdo-cd/debian-testing-amd64-i386-netinst.jigdo"
# - mount ---------------------------------------------------------------------
    mount -o loop ~/testing/debian-testing-amd64-i386-netinst.iso /mnt
    pushd /mnt
    find . -depth -print | cpio -pdm ~/testing/image/
    popd
    umount -f /mnt
# - i386 ----------------------------------------------------------------------
    cd ~/testing/install.386
    gunzip < ~/testing/image/install.386/initrd.gz | cpio -i
    cp -p ~/testing/preseed.cfg .
    mv ~/testing/image/install.386/initrd.gz ~/testing/image/install.386/initrd.gz.orig
    find . | cpio -H newc --create | gzip -9 > ~/testing/image/install.386/initrd.gz
    cat <<- _EOT_ > ~/testing/image/install.386/syslinux.cfg
		default vmlinuz
		append auto=true vga=normal file=/preseed.cfg initrd=initrd.gz priority=critical console-setup/ask_detect=false pkgsel/language-pack-patterns= pkgsel/install-language-support=false quiet --
_EOT_
# - amd -----------------------------------------------------------------------
    cd ~/testing/install.amd
    gunzip < ~/testing/image/install.amd/initrd.gz | cpio -i
    cp -p ~/testing/preseed.cfg .
    mv ~/testing/image/install.amd/initrd.gz ~/testing/image/install.amd/initrd.gz.orig
    find . | cpio -H newc --create | gzip -9 > ~/testing/image/install.amd/initrd.gz
    cat <<- _EOT_ > ~/testing/image/install.amd/syslinux.cfg
		default vmlinuz
		append auto=true vga=normal file=/preseed.cfg initrd=initrd.gz priority=critical console-setup/ask_detect=false pkgsel/language-pack-patterns= pkgsel/install-language-support=false quiet --
_EOT_
# - imaging -------------------------------------------------------------------
    cd ~/testing/image
    genisoimage -J -r -R -o ~/testing//debian-testing-amd64-i386-netinst-preseed.iso -b isolinux/isolinux.bin -c isolinux/boot.cat -no-emul-boot -boot-load-size 4 -boot-info-table .
  popd
# = copy ======================================================================
  cp -p ~/stable/*.iso  /mnt/hgfs/Share/My\ Documents/Download/linux/debian\ 8/
  cp -p ~/testing/*.iso /mnt/hgfs/Share/My\ Documents/Download/linux/debian\ 9/
# = eof =======================================================================
# apt-get -y install build-essential kernel-package libncurses5-dev fuse uuid-runtime linux-headers-`uname -r`
# mount /media/cdrom
# tar -xzf /media/cdrom/VMwareTools-*.tar.gz
# cd vmware-tools-distrib/
# ./vmware-install.pl -d -f
