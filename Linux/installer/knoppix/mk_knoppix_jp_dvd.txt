#!/bin/bash
# *****************************************************************************
# ** 日本語版KNOPPIXの作成(KNOPPIX_V7.6.1DVD-2016-01-16-EN.iso対応:DVD作業版)**
# *****************************************************************************

# =============================================================================
# == パソコンの準備                                                          ==
# =============================================================================

# -- 作業領域の確保 -----------------------------------------------------------
  sfdisk -s
  umount -l /media/sda1
  echo ,,83 | sfdisk -f /dev/sda
  mkfs.ext4 -F /dev/sda1

# -- 作業領域のマウント -------------------------------------------------------
  mount /dev/sda1 /media/sda1

# =============================================================================
# == KNOPPIXの展開                                                           ==
# =============================================================================

# -- 作業用ディレクトリの作成 -------------------------------------------------
  mkdir -p /media/sda1/knx/master
  mkdir -p /media/sda1/knx/source/KNOPPIX

# -- 展開 ---------------------------------------------------------------------
  rsync -aH                              /KNOPPIX/*    /media/sda1/knx/source/KNOPPIX
  rsync -aH --exclude="KNOPPIX/KNOPPIX*" /mnt-system/* /media/sda1/knx/master

# =============================================================================
# == カスタマイズ作業                                                        ==
# =============================================================================

# -- ルート変更の準備 ---------------------------------------------------------
  mount --bind /dev     /media/sda1/knx/source/KNOPPIX/dev
  mount -t proc proc    /media/sda1/knx/source/KNOPPIX/proc
  mount -t sysfs sysfs  /media/sda1/knx/source/KNOPPIX/sys
  mount --bind /dev/pts /media/sda1/knx/source/KNOPPIX/dev/pts
  mount --bind /tmp     /media/sda1/knx/source/KNOPPIX/tmp

# -- ルート変更 ---------------------------------------------------------------
  chroot /media/sda1/knx/source/KNOPPIX

# -- apt-getの準備 ------------------------------------------------------------
  cp -p /etc/resolv.conf /etc/resolv.conf.orig
  echo "nameserver 8.8.8.8" >> /etc/resolv.conf
  echo "nameserver 8.8.4.4" >> /etc/resolv.conf
  cp -p /etc/apt/sources.list /etc/apt/sources.list.orig
  sed "s/ftp\.de\.debian\.org/ftp\.jp\.debian\.org/" < /etc/apt/sources.list.orig > /etc/apt/sources.list
  rm -f /etc/apt/sources.list.orig

# -- 最新のパッケージリストを取得 ---------------------------------------------
  apt-get update

# -- 日本語キーボードレイアウト設定 -------------------------------------------
  echo "@setxkbmap -layout jp -option ctrl:swapcase" >> /etc/xdg/lxsession/LXDE/autostart

# -- 日本語入力システムのインストール -----------------------------------------
  apt-get -y install uim-anthy uim im-config
  im-config -n uim
  update-alternatives --auto uim-toolbar
  mkdir -p /home/knoppix/.xinput.d
  pushd /home/knoppix/.xinput.d
    ln -s /etc/X11/xinit/xinput.d/ja_JP ja_JP
    chown -R knoppix.knoppix /home/knoppix/.xinput.d
  popd

# -- Libreofficeの日本語化 ----------------------------------------------------
  wget "http://ftp.debian.org/debian/pool/main/libr/libreoffice/libreoffice-common_5.0.5~rc1-1_all.deb"
  wget "http://ftp.debian.org/debian/pool/main/libr/libreoffice/libreoffice-l10n-ja_5.0.5~rc1-1_all.deb"
  dpkg -i ./libreoffice-common_5.0.5~rc1-1_all.deb
  dpkg -i ./libreoffice-l10n-ja_5.0.5~rc1-1_all.deb
  rm -f ./libreoffice-common_5.0.5~rc1-1_all.deb
  rm -f ./libreoffice-l10n-ja_5.0.5~rc1-1_all.deb

# -- 不要なアプリの削除 -------------------------------------------------------
  apt-get -y remove --purge wine1.7 gcompris* linux-source-4.2.6 etoys*

# -- 不要なロケールデータの削除 -----------------------------------------------
  du -k /usr/share/locale/
  pushd /usr/share/locale/
  rm -rf be* bg* cs* da* de* es* fi* fr* he* hi* hu* it* nl* pl* ru* sk* sl* tr* zh*
  popd
  du -k /usr/share/locale/
  localedef --list-archive
  localedef --list-archive | grep -v -e ^ja -e ^en_GB -e en_US | xargs localedef --delete-from-archive
  localedef --list-archive

# =============================================================================
# == 後片付け                                                                ==
# =============================================================================

# -- 使われていないパッケージの削除 -------------------------------------------
  apt-get -y -f install
  apt-get -y autoremove
  apt-get autoclean

# -- DNS参照設定を解除 --------------------------------------------------------
  mv -f /etc/resolv.conf.orig /etc/resolv.conf

# -- ルート変更の解除 ---------------------------------------------------------
  exit
  for i in dev/pts proc sys dev tmp; do
    umount -l /media/sda1/knx/source/KNOPPIX/$i
  done

# -- 不要ファイルの削除 -------------------------------------------------------
  rm -f  /media/sda1/knx/source/KNOPPIX/root/.bash_history
  rm -f  /media/sda1/knx/source/KNOPPIX/root/.viminfo
  rm -rf /media/sda1/knx/source/KNOPPIX/tmp/*
  rm -rf /media/sda1/knx/source/KNOPPIX/var/cache/apt/*.bin
  rm -rf /media/sda1/knx/source/KNOPPIX/var/cache/apt/archives/*.deb

# =============================================================================
# == イメージ作成                                                            ==
# =============================================================================

# -- 起動オプションの修正 -----------------------------------------------------
  cp -p /media/sda1/knx/master/boot/isolinux/isolinux.cfg /media/sda1/knx/master/boot/isolinux/isolinux.cfg.orig
  sed "s/lang=en/lang=ja/" < /media/sda1/knx/master/boot/isolinux/isolinux.cfg.orig | sed "s/tz=localtime/tz=Asia\/Tokyo/" > /media/sda1/knx/master/boot/isolinux/isolinux.cfg
  rm -f /media/sda1/knx/master/boot/isolinux/isolinux.cfg.orig

# -- 圧縮ファイルの作成 -------------------------------------------------------
  genisoimage -input-charset ISO-8859-15 -R -l -D -V "KNOPPIX_FS" -quiet -no-split-symlink-components -no-split-symlink-fields -hide-rr-moved -cache-inodes /media/sda1/knx/source/KNOPPIX | create_compressed_fs -q -B 65536 -t 8 -L 9 -f /media/sda1/knx/isotemp - /media/sda1/knx/master/KNOPPIX/KNOPPIX

# -- ISOイメージの作成 --------------------------------------------------------
  pushd /media/sda1/knx/master
    find -type f -not -name sha1sums -not -name boot.cat -not -name isolinux.bin -exec sha1sum '{}' \; > KNOPPIX/sha1sums
    genisoimage -l -r -J -V "KNOPPIX7.6.1JP" -b boot/isolinux/isolinux.bin -no-emul-boot -boot-load-size 4 -boot-info-table -c boot/isolinux/boot.cat -o /media/sda1/knx/KNOPPIX_V7.6.1DVD-2016-01-16-JP.iso /media/sda1/knx/master
  popd

# =============================================================================
# == EOF                                                                     ==
# =============================================================================
